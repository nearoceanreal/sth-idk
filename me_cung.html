<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≤ Ch∆°i M√™ Cung</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* NgƒÉn tr√¨nh duy·ªát cu·ªôn trang khi ch·∫°m tr√™n mobile */
            touch-action: none;
            /* NgƒÉn ng∆∞·ªùi d√πng ch·ªçn vƒÉn b·∫£n */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE10+ */
            user-select: none; /* Standard */
        }
        canvas {
            background-color: #000000; /* N·ªÅn canvas m√†u ƒëen */
            border: 2px solid #4b5563; /* Vi·ªÅn m√†u x√°m ƒë·∫≠m h∆°n */
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); /* ƒê·ªï b√≥ng m√†u ƒë·ªè n·ªïi b·∫≠t h∆°n */
            transition: transform 0.3s ease-in-out; /* Th√™m transition cho canvas */
        }
        /* Ki·ªÉu d√°ng cho c√°c n√∫t ƒëi·ªÅu khi·ªÉn c·∫£m ·ª©ng */
        .touch-controls button {
            width: 65px; /* K√≠ch th∆∞·ªõc n√∫t l·ªõn h∆°n cho d·ªÖ ch·∫°m */
            height: 65px;
            font-size: 28px; /* K√≠ch th∆∞·ªõc ch·ªØ/bi·ªÉu t∆∞·ª£ng l·ªõn h∆°n */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%; /* L√†m cho n√∫t tr√≤n */
            transition: background-color 0.2s, transform 0.1s;
        }
        .touch-controls button:active {
            transform: scale(0.95); /* Hi·ªáu ·ª©ng nh·∫•n n√∫t */
        }
        /* Ki·ªÉu d√°ng ti√™u ƒë·ªÅ */
        #title {
            font-size: 2.5rem; /* K√≠ch th∆∞·ªõc ch·ªØ ƒë√°p ·ª©ng cho ti√™u ƒë·ªÅ */
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        /* ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc ti√™u ƒë·ªÅ cho m√†n h√¨nh l·ªõn h∆°n (v√≠ d·ª•: m√°y t√≠nh b·∫£ng, m√°y t√≠nh ƒë·ªÉ b√†n) */
        @media (min-width: 768px) {
            #title {
                font-size: 3.5rem;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-black flex flex-col items-center justify-center min-h-screen p-4">

    <div class="text-center mb-6">
        <h1 id="title" class="text-red-500 font-extrabold tracking-wide">TR√í CH∆†I M√ä CUNG</h1>
        <p class="text-gray-300 mt-3 text-lg">S·ª≠ d·ª•ng c√°c ph√≠m m≈©i t√™n (ho·∫∑c c√°c n√∫t b√™n d∆∞·ªõi) ƒë·ªÉ ƒëi ƒë·∫øn l√° c·ªù!</p>
    </div>

    <!-- Canvas cho m√™ cung. max-w-full v√† h-auto gi√∫p n√≥ ƒë√°p ·ª©ng v·ªõi k√≠ch th∆∞·ªõc m√†n h√¨nh. -->
    <canvas id="mazeCanvas" class="max-w-full h-auto"></canvas>

    <!-- Khu v·ª±c hi·ªÉn th·ªã th√¥ng b√°o chi·∫øn th·∫Øng -->
    <div id="message" class="mt-6 text-3xl font-extrabold text-green-400 h-10 transform transition-transform duration-300 ease-out"></div>
    
    <!-- N√∫t "Ch∆°i L·∫°i" -->
    <button id="newGameButton" class="mt-8 px-8 py-4 bg-red-600 text-white text-xl font-bold rounded-full shadow-lg hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-75 transition-all transform hover:scale-110 active:scale-95">
        Ch∆°i L·∫°i
    </button>

    <!-- B·∫£ng ƒëi·ªÅu khi·ªÉn c·∫£m ·ª©ng cho di ƒë·ªông (ch·ªâ hi·ªÉn th·ªã tr√™n m√†n h√¨nh nh·ªè h∆°n md) -->
    <div class="touch-controls mt-8 grid grid-cols-3 gap-3 w-60 md:hidden">
        <div></div>
        <button id="btn-up" class="bg-red-500 text-white rounded-full shadow-md active:bg-red-600">‚Üë</button>
        <div></div>
        <button id="btn-left" class="bg-red-500 text-white rounded-full shadow-md active:bg-red-600">‚Üê</button>
        <button id="btn-down" class="bg-red-500 text-white rounded-full shadow-md active:bg-red-600">‚Üì</button>
        <button id="btn-right" class="bg-red-500 text-white rounded-full shadow-md active:bg-red-600">‚Üí</button>
    </div>

    <script>
        // L·∫•y c√°c ph·∫ßn t·ª≠ HTML
        const canvas = document.getElementById('mazeCanvas');
        const ctx = canvas.getContext('2d');
        const messageEl = document.getElementById('message');
        const newGameButton = document.getElementById('newGameButton');

        // C·∫•u h√¨nh m√™ cung
        const TILE_SIZE = 25; // K√≠ch th∆∞·ªõc c∆° b·∫£n c·ªßa m·ªói √¥
        let MAZE_ROWS; // S·ªë h√†ng c·ªßa m√™ cung
        let MAZE_COLS; // S·ªë c·ªôt c·ªßa m√™ cung
        let maze = [];

        // ƒê·ªãnh nghƒ©a ng∆∞·ªùi ch∆°i v√† m·ª•c ti√™u
        let player = { x: 1, y: 1, color: '#3b82f6', size: TILE_SIZE * 0.6 }; // Ng∆∞·ªùi ch∆°i m√†u xanh n·ªïi b·∫≠t
        let goal = {}; // V·ªã tr√≠ m·ª•c ti√™u
        let gameWon = false; // Tr·∫°ng th√°i chi·∫øn th·∫Øng tr√≤ ch∆°i

        /**
         * H√†m t·∫°o m√™ cung ng·∫´u nhi√™n b·∫±ng thu·∫≠t to√°n Recursive Backtracker (DFS)
         * @param {number} rows - S·ªë h√†ng c·ªßa m√™ cung (ph·∫£i l√† s·ªë l·∫ª)
         * @param {number} cols - S·ªë c·ªôt c·ªßa m√™ cung (ph·∫£i l√† s·ªë l·∫ª)
         */
        function generateMaze(rows, cols) {
            let newMaze = Array(rows).fill(null).map(() => Array(cols).fill(1)); // 1 = t∆∞·ªùng, 0 = ƒë∆∞·ªùng ƒëi
            const stack = [];
            let current = { r: 1, c: 1 };
            newMaze[current.r][current.c] = 0; // √î b·∫Øt ƒë·∫ßu l√† ƒë∆∞·ªùng ƒëi
            
            // T√≠nh t·ªïng s·ªë √¥ ƒë∆∞·ªùng ƒëi c·∫ßn thi·∫øt cho thu·∫≠t to√°n t·∫°o m√™ cung
            const totalPathCells = Math.ceil((rows - 1) / 2) * Math.ceil((cols - 1) / 2);
            let visitedCount = 1;

            while (visitedCount < totalPathCells) {
                const { r, c } = current;
                const neighbors = [];

                // Ki·ªÉm tra c√°c √¥ l√¢n c·∫≠n ch∆∞a ƒë∆∞·ª£c thƒÉm (c√°ch 2 b∆∞·ªõc, b·ªè qua t∆∞·ªùng)
                if (r > 1 && newMaze[r - 2][c] === 1) neighbors.push({ r: r - 2, c: c, wall: { r: r - 1, c: c } }); // L√™n
                if (c < cols - 2 && newMaze[r][c + 2] === 1) neighbors.push({ r: r, c: c + 2, wall: { r: r, c: c + 1 } }); // Ph·∫£i
                if (r < rows - 2 && newMaze[r + 2][c] === 1) neighbors.push({ r: r + 2, c: c, wall: { r: r + 1, c: c } }); // Xu·ªëng
                if (c > 1 && newMaze[r][c - 2] === 1) neighbors.push({ r: r, c: c - 2, wall: { r: r, c: c - 1 } }); // Tr√°i

                if (neighbors.length > 0) {
                    const next = neighbors[Math.floor(Math.random() * neighbors.length)];
                    stack.push(current); // ƒê·∫©y √¥ hi·ªán t·∫°i v√†o stack
                    newMaze[next.wall.r][next.wall.c] = 0; // ƒê·ª•c ƒë∆∞·ªùng ƒëi qua t∆∞·ªùng
                    current = { r: next.r, c: next.c }; // Di chuy·ªÉn ƒë·∫øn √¥ ti·∫øp theo
                    newMaze[current.r][current.c] = 0; // ƒê√°nh d·∫•u √¥ ti·∫øp theo l√† ƒë∆∞·ªùng ƒëi
                    visitedCount++;
                } else if (stack.length > 0) {
                    current = stack.pop(); // Quay lui
                } else {
                    // Tr∆∞·ªùng h·ª£p n√†y x·ª≠ l√Ω khi thu·∫≠t to√°n c√≥ th·ªÉ b·ªã k·∫πt n·∫øu m·ªôt ph·∫ßn b·ªã c√¥ l·∫≠p
                    break;
                }
            }

            // ƒê·∫£m b·∫£o ƒëi·ªÉm b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c l√† ƒë∆∞·ªùng ƒëi
            newMaze[1][1] = 0; // V·ªã tr√≠ ng∆∞·ªùi ch∆°i b·∫Øt ƒë·∫ßu
            newMaze[rows - 2][cols - 2] = 0; // V·ªã tr√≠ m·ª•c ti√™u

            // ƒê·∫£m b·∫£o c√≥ ƒë∆∞·ªùng ƒëi ƒë·∫øn m·ª•c ti√™u n·∫øu n√≥ b·ªã t∆∞·ªùng bao quanh do ng·∫´u nhi√™n
            if (newMaze[rows - 3][cols - 2] === 1) newMaze[rows - 3][cols - 2] = 0;
            if (newMaze[rows - 2][cols - 3] === 1) newMaze[rows - 2][cols - 3] = 0;

            return newMaze;
        }

        /**
         * ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc m√™ cung d·ª±a tr√™n k√≠ch th∆∞·ªõc m√†n h√¨nh hi·ªán t·∫°i.
         * ƒê·∫£m b·∫£o s·ªë h√†ng v√† c·ªôt l√† s·ªë l·∫ª v√† c√≥ k√≠ch th∆∞·ªõc t·ªëi thi·ªÉu.
         */
        function setMazeDimensions() {
            // 90% chi·ªÅu r·ªông m√†n h√¨nh ƒë·ªÉ c√≥ kho·∫£ng tr·ªëng
            const maxCanvasWidth = window.innerWidth * 0.9;
            // 60% chi·ªÅu cao m√†n h√¨nh ƒë·ªÉ ch·ª´a ch·ªó cho ƒëi·ªÅu khi·ªÉn
            const maxCanvasHeight = window.innerHeight * 0.6;

            // T√≠nh to√°n s·ªë c·ªôt v√† h√†ng t·ªëi ƒëa c√≥ th·ªÉ v·ª´a, ƒë·∫£m b·∫£o ch√∫ng l√† s·ªë l·∫ª
            MAZE_COLS = Math.floor(maxCanvasWidth / TILE_SIZE);
            MAZE_ROWS = Math.floor(maxCanvasHeight / TILE_SIZE);

            // ƒê·∫£m b·∫£o s·ªë c·ªôt v√† h√†ng l√† s·ªë l·∫ª
            MAZE_COLS = MAZE_COLS % 2 === 0 ? MAZE_COLS - 1 : MAZE_COLS;
            MAZE_ROWS = MAZE_ROWS % 2 === 0 ? MAZE_ROWS - 1 : MAZE_ROWS;

            // ƒê·∫£m b·∫£o k√≠ch th∆∞·ªõc t·ªëi thi·ªÉu ƒë·ªÉ tr√≤ ch∆°i c√≥ th·ªÉ ch∆°i ƒë∆∞·ª£c
            MAZE_COLS = Math.max(15, MAZE_COLS); // T·ªëi thi·ªÉu 15 c·ªôt
            MAZE_ROWS = Math.max(15, MAZE_ROWS); // T·ªëi thi·ªÉu 15 h√†ng

            // ƒê·∫£m b·∫£o h√†ng v√† c·ªôt √≠t nh·∫•t l√† 3 (1 t∆∞·ªùng, 1 ƒë∆∞·ªùng ƒëi, 1 t∆∞·ªùng)
            MAZE_COLS = MAZE_COLS < 3 ? 3 : MAZE_COLS;
            MAZE_ROWS = MAZE_ROWS < 3 ? 3 : MAZE_ROWS;
            
            // ƒêi·ªÅu ch·ªânh l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o ch√∫ng l√† s·ªë l·∫ª (ph√≤ng tr∆∞·ªùng h·ª£p min size l√†m ch·∫µn)
            if (MAZE_COLS % 2 === 0) MAZE_COLS--;
            if (MAZE_ROWS % 2 === 0) MAZE_ROWS--;

            // Fallback cho m√†n h√¨nh r·∫•t nh·ªè n·∫øu v·∫´n l√† s·ªë ch·∫µn
            if (MAZE_COLS < 3) MAZE_COLS = 3;
            if (MAZE_ROWS < 3) MAZE_ROWS = 3;

            // ƒê·∫∑t k√≠ch th∆∞·ªõc canvas
            canvas.width = MAZE_COLS * TILE_SIZE;
            canvas.height = MAZE_ROWS * TILE_SIZE;
        }

        // H√†m kh·ªüi t·∫°o v√† v·∫Ω game
        function init() {
            setMazeDimensions(); // ƒê·∫∑t k√≠ch th∆∞·ªõc d·ª±a tr√™n k√≠ch th∆∞·ªõc m√†n h√¨nh hi·ªán t·∫°i
            maze = generateMaze(MAZE_ROWS, MAZE_COLS);
            player.x = 1;
            player.y = 1;
            goal.x = MAZE_COLS - 2;
            goal.y = MAZE_ROWS - 2;
            gameWon = false;
            messageEl.textContent = '';
            canvas.style.transform = 'scale(1)'; // ƒê·∫∑t l·∫°i t·ª∑ l·ªá canvas
            drawGame();
        }

        // H√†m v·∫Ω to√†n b·ªô game
        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // X√≥a canvas
            drawMaze(); // V·∫Ω m√™ cung
            drawGoal(); // V·∫Ω m·ª•c ti√™u
            drawPlayer(); // V·∫Ω ng∆∞·ªùi ch∆°i
        }

        // H√†m v·∫Ω m√™ cung
        function drawMaze() {
            for (let row = 0; row < MAZE_ROWS; row++) {
                for (let col = 0; col < MAZE_COLS; col++) {
                    if (maze[row][col] === 1) {
                        ctx.fillStyle = '#dc2626'; // M√†u t∆∞·ªùng ƒë·ªè
                        ctx.fillRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }
            }
        }

        // H√†m v·∫Ω ng∆∞·ªùi ch∆°i
        function drawPlayer() {
            const playerX = player.x * TILE_SIZE + TILE_SIZE / 2;
            const playerY = player.y * TILE_SIZE + TILE_SIZE / 2;
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(playerX, playerY, player.size / 2, 0, 2 * Math.PI);
            ctx.fill();
        }

        // H√†m v·∫Ω m·ª•c ti√™u (l√° c·ªù)
        function drawGoal() {
            // S·ª≠ d·ª•ng font emoji ƒë·ªÉ hi·ªÉn th·ªã l√° c·ªù t·ªët h∆°n
            ctx.font = `${TILE_SIZE * 0.8}px 'Segoe UI Emoji', 'Inter', sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            const goalX = goal.x * TILE_SIZE + TILE_SIZE / 2;
            const goalY = goal.y * TILE_SIZE + TILE_SIZE / 2;
            ctx.fillText('üö©', goalX, goalY);
        }

        // H√†m x·ª≠ l√Ω di chuy·ªÉn ng∆∞·ªùi ch∆°i
        function movePlayer(dx, dy) {
            if (gameWon) return; // Kh√¥ng di chuy·ªÉn n·∫øu tr√≤ ch∆°i ƒë√£ th·∫Øng
            const nextX = player.x + dx;
            const nextY = player.y + dy;

            // Ki·ªÉm tra gi·ªõi h·∫°n v√† n·∫øu √¥ ti·∫øp theo l√† ƒë∆∞·ªùng ƒëi (0)
            if (nextY >= 0 && nextY < MAZE_ROWS && nextX >= 0 && nextX < MAZE_COLS && maze[nextY][nextX] === 0) {
                player.x = nextX;
                player.y = nextY;
                drawGame(); // V·∫Ω l·∫°i game sau khi di chuy·ªÉn
                checkWin(); // Ki·ªÉm tra xem ng∆∞·ªùi ch∆°i ƒë√£ th·∫Øng ch∆∞a
            }
        }

        // H√†m ki·ªÉm tra chi·∫øn th·∫Øng
        function checkWin() {
            if (player.x === goal.x && player.y === goal.y) {
                gameWon = true;
                messageEl.textContent = 'B·∫°n ƒë√£ th·∫Øng!';
                messageEl.classList.add('animate-bounce'); // Th√™m hi·ªáu ·ª©ng n·∫£y cho th√¥ng b√°o
                canvas.style.transform = 'scale(1.02)'; // Thu ph√≥ng nh·∫π canvas khi th·∫Øng
                setTimeout(() => {
                    canvas.style.transform = 'scale(1)'; // ƒê·∫∑t l·∫°i sau khi animation k·∫øt th√∫c
                    messageEl.classList.remove('animate-bounce');
                }, 1000);
            }
        }

        // L·∫Øng nghe s·ª± ki·ªán b√†n ph√≠m (cho m√°y t√≠nh ƒë·ªÉ b√†n/m√°y t√≠nh x√°ch tay)
        window.addEventListener('keydown', (e) => {
            switch (e.key) {
                case 'ArrowUp': case 'w': movePlayer(0, -1); break;
                case 'ArrowDown': case 's': movePlayer(0, 1); break;
                case 'ArrowLeft': case 'a': movePlayer(-1, 0); break;
                case 'ArrowRight': case 'd': movePlayer(1, 0); break;
            }
        });
        
        // L·∫Øng nghe s·ª± ki·ªán n√∫t "Ch∆°i L·∫°i"
        newGameButton.addEventListener('click', init);

        // L·∫Øng nghe s·ª± ki·ªán cho c√°c n√∫t ƒëi·ªÅu khi·ªÉn c·∫£m ·ª©ng
        document.getElementById('btn-up').addEventListener('click', () => movePlayer(0, -1));
        document.getElementById('btn-down').addEventListener('click', () => movePlayer(0, 1));
        document.getElementById('btn-left').addEventListener('click', () => movePlayer(-1, 0));
        document.getElementById('btn-right').addEventListener('click', () => movePlayer(1, 0));

        // Th√™m s·ª± ki·ªán ch·∫°m v√†o canvas ƒë·ªÉ di chuy·ªÉn nh√¢n v·∫≠t
        canvas.addEventListener('touchend', (e) => {
            if (gameWon) return; // Kh√¥ng x·ª≠ l√Ω ch·∫°m n·∫øu tr√≤ ch∆°i ƒë√£ th·∫Øng
            // L·∫•y v·ªã tr√≠ ch·∫°m t∆∞∆°ng ƒë·ªëi tr√™n canvas
            const touchX = e.changedTouches[0].clientX - canvas.getBoundingClientRect().left;
            const touchY = e.changedTouches[0].clientY - canvas.getBoundingClientRect().top;

            // T√≠nh to√°n v·ªã tr√≠ trung t√¢m c·ªßa ng∆∞·ªùi ch∆°i tr√™n canvas
            const playerCanvasX = player.x * TILE_SIZE + TILE_SIZE / 2;
            const playerCanvasY = player.y * TILE_SIZE + TILE_SIZE / 2;

            // T√≠nh to√°n ƒë·ªô l·ªách t·ª´ v·ªã tr√≠ ng∆∞·ªùi ch∆°i ƒë·∫øn ƒëi·ªÉm ch·∫°m
            const deltaX = touchX - playerCanvasX;
            const deltaY = touchY - playerCanvasY;

            // X√°c ƒë·ªãnh h∆∞·ªõng di chuy·ªÉn d·ª±a tr√™n ƒë·ªô l·ªách l·ªõn nh·∫•t
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                // Di chuy·ªÉn ngang
                if (deltaX > 0) {
                    movePlayer(1, 0); // Sang ph·∫£i
                } else {
                    movePlayer(-1, 0); // Sang tr√°i
                }
            } else {
                // Di chuy·ªÉn d·ªçc
                if (deltaY > 0) {
                    movePlayer(0, 1); // Xu·ªëng
                } else {
                    movePlayer(0, -1); // L√™n
                }
            }
        });

        // Kh·ªüi ƒë·ªông game khi t·∫£i trang v√† khi c·ª≠a s·ªï thay ƒë·ªïi k√≠ch th∆∞·ªõc
        window.onload = init;
        window.addEventListener('resize', init); // Kh·ªüi t·∫°o l·∫°i m√™ cung khi thay ƒë·ªïi k√≠ch th∆∞·ªõc m√†n h√¨nh ƒë·ªÉ ƒë√°p ·ª©ng
    </script>
</body>
</html>
